#!/bin/bash

# =============================================================================
# Project: The Walking Dead: 22 Domains
# Tool: Multi-Domain Malware & Persistence Scanner
# Description: Scans for Immutable files, Web Shells, and missing Hardening.
# =============================================================================

TARGET_DIR=${1:-"."}

echo "--------------------------------------------------------"
echo "ðŸ§Ÿ Starting 'Walking Dead' Audit in: $TARGET_DIR"
echo "--------------------------------------------------------"

# 1. SCAN FOR IMMUTABLE ZOMBIES (+i attribute)
echo "[!] Searching for Immutable 'God Mode' files..."
# This uses the logic from your Lab
if command -v lsattr &> /dev/null; then
    sudo lsattr -R "$TARGET_DIR" 2>/dev/null | grep "\----i" || echo "  > No immutable files found."
else
    echo "  > lsattr not found. Skipping attribute check (common on macOS)."
fi

echo ""

# 2. SCAN FOR SUSPICIOUS WEBSHELL PATTERNS
echo "[!] Searching for common Web Shell signatures (eval, base64_decode, shell_exec)..."
grep -rE "eval\(|base64_decode\(|shell_exec\(|passthru\(|system\(" "$TARGET_DIR" \
    --include="*.php" \
    --exclude-dir={wp-admin,wp-includes,node_modules} \
    -l || echo "  > No obvious shell patterns found."

echo ""

# 3. SCAN FOR TYPO-SQUATTING (e.g., wp-confiq.php)
echo "[!] Checking for common Typo-Squatting filenames..."
find "$TARGET_DIR" -type f \( -name "wp-confiq.php" -o -name "wp-l0gin.php" -o -name "lock360.php" \)

echo ""

# 4. AUDIT WORDPRESS HARDENING
echo "[!] Checking for 'DISALLOW_FILE_EDIT' in wp-config.php..."
find "$TARGET_DIR" -name "wp-config.php" -exec grep -L "DISALLOW_FILE_EDIT" {} + | sed 's/^/  > MISSING HARDENING: /'

echo ""
echo "--------------------------------------------------------"
echo "âœ… Audit Complete."
echo "--------------------------------------------------------"
