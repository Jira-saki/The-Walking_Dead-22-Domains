# ðŸ”¬ Malware Technical Analysis: The "Gecko" & The "Guardian"

This document provides a detailed technical breakdown of the malware components, persistence mechanisms, and attack infrastructure identified during the remediation of the 22-domain botnet infection.

---

## 1. Persistence Mechanism: The Guardian Script

### Behavior
A background PHP process that monitors the integrity of critical files (`index.php`, `.htaccess`, and configuration files). The script maintains a "heartbeat" to ensure malicious code remains active.

### Trigger & Restoration Loop
If the monitored file size changes or the file is deleted, the Guardian script immediately fetches a backup from a hidden directory (often `.tmb` or `ALFA_DATA`) and overwrites the clean file.

**Timeline of Attack:**
1. Initial deletion attempt â†’ Operation succeeds
2. Guardian detects file absence
3. Backup copy restored from hidden directory
4. Malicious payload re-injected
5. Cycle repeats indefinitely

### Countermeasure
To break this persistence loop, I implemented a **"Freeze Strategy"**:
```bash
chmod 0000 malware.php           # Remove all permissions
```
This rendered the Guardian script unable to read its own source code before attempting deletion, effectively breaking the restoration logic.

---

## 2. Remote Access: The Gecko Shell

### Overview
Multiple instances of the Gecko Shell were identified across domains (e.g., `GyvExrKex.php`, `index_backup.php`).

### Capabilities
- **File Management:** Browse filesystem, upload/download files
- **Terminal Access:** Execute arbitrary shell commands (`system()`, `shell_exec()`)
- **GUI Interface:** User-friendly dashboard for attacker operations
- **Session Persistence:** Cookie-based authentication to maintain access

### Evasion Techniques
The shell employed **Unicode Obfuscation** to bypass Web Application Firewalls (WAF):
- Standard string: `domain`
- Obfuscated variant: `â““omain` (using Unicode circle enclosures)
- Result: String-matching signatures fail to detect the payload

---

## 3. Privilege Escalation: Immutable Bit (+i)

### Mechanism
The attacker used the Linux `chattr +i` command to lock files at the **kernel level**:
```bash
chattr +i sensitive_file.php     # Lock file
lsattr sensitive_file.php        # Verify immutable bit
----i----------C------ sensitive_file.php
```

### Impact
- **Standard deletion fails:** `rm -rf` returns "Operation not permitted"
- **Root cannot override:** Even root user must unlock (`chattr -i`) before deletion
- **Kernel-enforced:** Attribute is enforced at filesystem level, not just permissions

### Significance
The presence of immutable bits on web-accessible files suggests the attacker **successfully escalated privileges** to root or a highly privileged account, indicating compromise of system-level credentials or exploitation of a kernel vulnerability.

---

## 4. C2 Infrastructure

### Identified Command & Control Domains
The malware attempted to establish communication with the following domains to receive instructions or download secondary payloads:

| Domain | Status | Purpose |
|--------|--------|---------|
| `zvo4.xyz` | Blocked | Primary C2 server |
| `zqg5ai.bnshgy.top` | Blocked | Secondary C2 endpoint |
| `vpsdd.dfqfat.top` | Blocked | Tertiary C2 server |

### Firewall Mitigation
All C2 domains were added to firewall blocklists and DNS filters to prevent outbound beaconing:
```bash
# Example: Outbound DNS blocking rule
iptables -A OUTPUT -d zvo4.xyz -j DROP
iptables -A OUTPUT -d zqg5ai.bnshgy.top -j DROP
iptables -A OUTPUT -d vpsdd.dfqfat.top -j DROP
```

---

## References

- [README.md](../README.md) â€” Complete incident response narrative
- [malware-scanner.sh](../scripts/malware-scanner.sh) â€” Automated detection tool
- Immutable File Attributes: `man chattr`, `man lsattr`
- PHP Security Functions: `eval()`, `base64_decode()`, `system()`, `shell_exec()`
